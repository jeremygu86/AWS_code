"use strict";define("bundles/programming/components/GridSubmission",["require","exports","module","react-with-addons","underscore","bundles/phoenix/components/Modal","bundles/phoenix/components/OrigamiRegion","bundles/phoenix/lib/multitrackerMixin","bundles/phoenix/utils/templateTags","bundles/verification/viewModels/verificationModule","bundles/verification/views/verificationModule","i18n!nls/programming","bundles/programming/components/GridSubmissionUploadTable","css!bundles/programming/components/__styles__/GridSubmission.css"],function(require,exports,module){var i=require("react-with-addons"),_=require("underscore"),r=require("bundles/phoenix/components/Modal"),u=require("bundles/phoenix/components/OrigamiRegion"),n=require("bundles/phoenix/lib/multitrackerMixin"),s=require("bundles/phoenix/utils/templateTags"),o=require("bundles/verification/viewModels/verificationModule"),d=require("bundles/verification/views/verificationModule"),t=require("i18n!nls/programming"),l=require("bundles/programming/components/GridSubmissionUploadTable");require("css!bundles/programming/components/__styles__/GridSubmission.css");var p=s.TRIM,e=function getMetadata(i){return function(){return this.props.itemMetadata.get(i)}},a=i.createClass({displayName:"GridSubmission",mixins:[n],multitracker:{namespace:"open_course_item.programing_grid_submissions",baseValues:["open_course_id","module_id","lesson_id","item_id"],definitions:{open_course_id:e("course.id"),module_id:e("lesson.module.id"),lesson_id:e("lesson.id"),item_id:e("id")},events:{upload:[],upload_error:[],submit:[],submit_error:[]}},getInitialState:function getInitialState(){return{inputDisabled:!1,currentUploadCount:0}},componentDidMount:function componentDidMount(){this.props.inputViewModel.on("change:inputDisabled",this.updateInputs),this.props.isVerifiable&&(this.verificationViewModel=this.props.verificationViewModel||new o({verificationDisplay:this.props.verificationDisplay,metadata:this.props.itemMetadata,canOptOut:void 0===this.props.canOptOut?!0:this.props.canOptOut}),this.verificationViewModel.on("verificationComplete",this.onVerificationComplete))},componentWillUnmount:function componentWillUnmount(){this.props.inputViewModel.off("change:inputDisabled",this.updateInputs)},updateInputs:function updateInputs(){this.setState({inputDisabled:this.props.inputViewModel.get("inputDisabled")})},onVerificationComplete:function onVerificationComplete(i){this.setState({isVerifying:!1}),this.submit(i)},verifyToSubmit:function verifyToSubmit(){this.props.isVerifiable&&!this.verifiableId?this.setState({isVerifying:!0}):this.submit()},submit:function submit(i){i&&(this.verifiableId=i.hasVerified&&this.verificationViewModel.get("verifiableId")),this.track("submit"),this.props.viewModel.submit(this.verifiableId).then(this.onSubmitSuccess,this.onSubmitError).done()},onSubmitSuccess:function onSubmitSuccess(){this.props.onSubmit&&this.props.onSubmit()},onSubmitError:function onSubmitError(i){throw this.track("submit_error"),i},onUploadSelect:function onUploadSelect(){this.setState({currentUploadCount:this.state.currentUploadCount+1})},onPostUploadPartSuccess:function onPostUploadPartSuccess(i){this.track("upload"),this.setState({currentUploadCount:this.state.currentUploadCount-1})},onUploadError:function onUploadError(i){this.track("upload_error"),this.setState({currentUploadCount:this.state.currentUploadCount-1})},onVerificationModalClose:function onVerificationModalClose(){this.setState({isVerifying:!1})},render:function render(){var e=this.props,n=e.filesWorkspace,m=e.itemMetadata,h=e.inputViewModel,p=e.learnerAssignment,a=e.viewModel,s=this.state,b=s.currentUploadCount,o=s.inputDisabled,f=s.isVerifying,g=n&&_(n.get("parts")).some(function(i){return"uploaded"==i.typeName}),c=!g||b>0||o;return i.createElement("div",{className:"rc-GridSubmission"},i.createElement("p",null,t("To upload a file, click the part below. Then, submit the files. You\n               can submit as many times as you like. You do not need to upload all\n               parts in order to submit.")),i.createElement("div",{className:"submission-area"},i.createElement(l,{itemMetadata:m,filesWorkspace:n,learnerAssignment:p,viewModel:a,inputViewModel:h,inputDisabled:o,onUploadSelect:this.onUploadSelect,onPostUploadPartSuccess:this.onPostUploadPartSuccess,onUploadError:this.onUploadError}),i.createElement("button",{className:"submit-button success fullbleed",onClick:this.verifyToSubmit,disabled:c},t("Submit"))),f&&i.createElement(r,{modalName:"Programming Assignment Submission",handleClose:this.onVerificationModalClose},i.createElement("h2",{className:"title"},"Verify to Submit"),i.createElement(u,{renderOnce:!0,ViewClass:d,viewOptions:{verificationViewModel:this.verificationViewModel}})))}});module.exports=a});